name: Offload Harness

on:
  workflow_dispatch: {}
  push:
    branches:
      - main

jobs:
  run-harness:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install Python deps (including rocksdict) and project
        run: |
          python -m pip install --upgrade pip
          # Prefer the rocksdict package (Python wrapper around RocksDB) over
          # compiling/linking to system RocksDB in CI. Install it first so it's
          # available for the test harness and any other packages.
          pip install rocksdict
          # Install runtime requirements
          pip install -r requirements.txt
          # Install this project in editable mode with dev extras so tests and
          # local harness can import `sigil_mcp` and tools like pytest are
          # available in CI (pytest is in the [dev] extras in pyproject.toml).
          pip install -e '.[dev]'

      - name: Run offload harness
        env:
          # Keep embeddings disabled to avoid heavyweight providers in CI
          SIGIL_MCP_EMBEDDINGS_ENABLED: 'false'
          SIGIL_MCP_PRO_ACTIVE: '0'
          SIGIL_MCP_MODE: 'ci'
          # Disable file watching to avoid background flakes
          SIGIL_MCP_WATCH_ENABLED: 'false'
        run: |
          python tests/harness/run_offload_harness.py
